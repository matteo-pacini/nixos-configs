# Nexus Diskpool Handbook

## Quick Reference

| Item | Value |
|------|-------|
| Data Disks | disk0–disk9 (LUKS → ext4 → mergerfs) |
| Parity Disks | parity1, parity2 (ext4, unencrypted) |
| Pool Mount | `/diskpool` |
| Individual Mounts | `/mnt/disk0` to `/mnt/disk9` |
| Parity Mounts | `/mnt/parity1`, `/mnt/parity2` |
| Encryption Keys | `/run/agenix/nexus/diskX` |
| SnapRAID Config | `/etc/snapraid.conf` (generated by NixOS) |

---

## Architecture Overview

```
┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                              /diskpool (mergerfs)                                                                                                │
├───────────────────┬───────────────────┬───────────────────┬───────────────────┬───────────────────┬───────────────────┬───────────────────┬───────────────────┬───────────────────┬───────────────────────────────┤
│    /mnt/disk0     │    /mnt/disk1     │    /mnt/disk2     │    /mnt/disk3     │    /mnt/disk4     │    /mnt/disk5     │    /mnt/disk6     │    /mnt/disk7     │    /mnt/disk8     │    /mnt/disk9                 │
├───────────────────┼───────────────────┼───────────────────┼───────────────────┼───────────────────┼───────────────────┼───────────────────┼───────────────────┼───────────────────┼───────────────────────────────┤
│       ext4        │       ext4        │       ext4        │       ext4        │       ext4        │       ext4        │       ext4        │       ext4        │       ext4        │       ext4                    │
├───────────────────┼───────────────────┼───────────────────┼───────────────────┼───────────────────┼───────────────────┼───────────────────┼───────────────────┼───────────────────┼───────────────────────────────┤
│       LUKS        │       LUKS        │       LUKS        │       LUKS        │       LUKS        │       LUKS        │       LUKS        │       LUKS        │       LUKS        │       LUKS                    │
│ acc41b71-316b-... │ 10b7a53d-00d7-... │ 5f612cb9-5386-... │ 46707d5b-8251-... │ 468f45f0-1ec1-... │ 3af3cf56-3141-... │ bea58b71-f5e1-... │ 5c754299-f3d7-... │ 58caf63b-4142-... │ 293952af-363d-...             │
├───────────────────┼───────────────────┼───────────────────┼───────────────────┼───────────────────┼───────────────────┼───────────────────┼───────────────────┼───────────────────┼───────────────────────────────┤
│ 9.1TB Seagate     │ 7.3TB WDC         │ 9.1TB WDC         │ 9.1TB Seagate     │ 7.3TB WDC         │ 9.1TB Seagate     │ 7.3TB WDC         │ 9.1TB WDC         │ 7.3TB WDC         │ 9.1TB WDC                     │
│ Barracuda Pro     │ WD80EFAX-68KNBN0  │ WD101EMAZ-11G7DA0 │ Barracuda Pro     │ WD80EFAX-68KNBN0  │ Barracuda Pro     │ WD80EFAX-68LHPN0  │ WD101EDBZ-11B1DA0 │ WD80EFAX-68LHPN0  │ WD101EDBZ-11B1DA0             │
└───────────────────┴───────────────────┴───────────────────┴───────────────────┴───────────────────┴───────────────────┴───────────────────┴───────────────────┴───────────────────┴───────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                  SnapRAID Parity (dual - survives 2 failures)                                                                                    │
├──────────────────────────────────────────────────────────────────────────────────────────────────────┬───────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│  /mnt/parity1                                                                                        │  /mnt/parity2                                                                                             │
│  ext4 (unencrypted)                                                                                  │  ext4 (unencrypted)                                                                                       │
│  snapraid.parity                                                                                     │  snapraid.2-parity                                                                                        │
│  9.1TB WDC WD101EMAZ-11G7DA0                                                                         │  9.1TB WDC WD101EMAZ-11G7DA0                                                                              │
│  UUID: 1a81ffca-7112-49de-bce6-804e9657e4ed                                                          │  UUID: eaeeac6a-40ae-4088-8680-1a6e0146cecd                                                               │
└──────────────────────────────────────────────────────────────────────────────────────────────────────┴───────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## LUKS Encryption

Each data disk (disk0–disk9) is encrypted with LUKS2:

| Parameter | Value |
|-----------|-------|
| Cipher | AES-XTS-plain64 |
| Key Size | 512-bit |
| Hash | SHA256 |
| PBKDF | Argon2id |
| Key Management | agenix (decrypted at boot) |

The `/etc/crypttab` maps LUKS UUIDs to agenix key files:

```
disk0   UUID=acc41b71-...   /run/agenix/nexus/disk0
disk1   UUID=10b7a53d-...   /run/agenix/nexus/disk1
...
```

**Configuration**: `hosts/Nexus/hardware-extra.nix`

---

## ext4 Filesystem

All data and parity disks use ext4:

| Parameter | Value |
|-----------|-------|
| Mount options | `defaults,noatime` |
| neededForBoot | false |

---

## mergerfs Pool

The `/diskpool` mount combines all 10 data disks into a unified namespace:

| Option | Value | Description |
|--------|-------|-------------|
| `allow_other` | enabled | Allow non-root users to access |
| `cache.files` | partial | Partial file caching for performance |
| `dropcacheonclose` | true | Free cache when files are closed |
| `category.create` | mfs | New files go to disk with **most free space** |
| `posix_acl` | true | Enable POSIX ACLs |

**Configuration**: `hosts/Nexus/hardware-extra.nix`

---

## SnapRAID Parity

SnapRAID provides snapshot-based parity protection:

| Setting | Value |
|---------|-------|
| Data disks | d0–d9 → `/mnt/disk0` to `/mnt/disk9` |
| Content files | `/mnt/diskX/snapraid.content` (one per disk) |
| Parity file | `/mnt/parity1/snapraid.parity` |
| 2-parity file | `/mnt/parity2/snapraid.2-parity` |
| Exclusions | `*.unrecoverable`, `/tmp/`, `/lost+found/` |
| Touch before sync | enabled |

With dual parity, SnapRAID can recover from up to **2 simultaneous disk failures**.

**Note**: The NixOS snapraid-sync and snapraid-scrub timers are disabled; sync is triggered during the backup job.

**Configuration**: `hosts/Nexus/snapraid.nix`

---

## Physical Disk Inventory

### Data Disks (LUKS encrypted)

| Mountpoint | Capacity | Model | LUKS UUID |
|------------|----------|-------|-----------|
| `/mnt/disk0` | 9.1TB | Seagate Barracuda Pro (X377_HLBRE10TA07) | `acc41b71-316b-45d8-8f0b-7451f07704e5` |
| `/mnt/disk1` | 7.3TB | WDC Red Pro (WD80EFAX-68KNBN0) | `10b7a53d-00d7-44b8-a939-81e5e97cb39b` |
| `/mnt/disk2` | 9.1TB | WDC Red Pro (WD101EMAZ-11G7DA0) | `5f612cb9-5386-4bad-9ac7-63cc5297886a` |
| `/mnt/disk3` | 9.1TB | Seagate Barracuda Pro (X377_HLBRE10TA07) | `46707d5b-8251-4b0d-b1b1-5342e5b869cc` |
| `/mnt/disk4` | 7.3TB | WDC Red Pro (WD80EFAX-68KNBN0) | `468f45f0-1ec1-4345-ac77-54bb16a5c064` |
| `/mnt/disk5` | 9.1TB | Seagate Barracuda Pro (X377_HLBRE10TA07) | `3af3cf56-3141-422b-9de3-06b0849bf7ca` |
| `/mnt/disk6` | 7.3TB | WDC Red Pro (WD80EFAX-68LHPN0) | `bea58b71-f5e1-4406-8312-70c8ee850536` |
| `/mnt/disk7` | 9.1TB | WDC Red Pro (WD101EDBZ-11B1DA0) | `5c754299-f3d7-42ad-9156-35c97c70a269` |
| `/mnt/disk8` | 7.3TB | WDC Red Pro (WD80EFAX-68LHPN0) | `58caf63b-4142-45ab-8392-ba02cc4a86f3` |
| `/mnt/disk9` | 9.1TB | WDC Red Pro (WD101EDBZ-11B1DA0) | `293952af-363d-4ca1-bb74-23e22d67b393` |

### Parity Disks (unencrypted ext4)

| Mountpoint | Capacity | Model | Filesystem UUID |
|------------|----------|-------|-----------------|
| `/mnt/parity1` | 9.1TB | WDC Red Pro (WD101EMAZ-11G7DA0) | `1a81ffca-7112-49de-bce6-804e9657e4ed` |
| `/mnt/parity2` | 9.1TB | WDC Red Pro (WD101EMAZ-11G7DA0) | `eaeeac6a-40ae-4088-8680-1a6e0146cecd` |

### Total Capacity

| Metric | Value |
|--------|-------|
| Raw capacity | ~82TB (10 data + 2 parity) |
| Usable capacity | ~73TB (with dual parity protection) |

---

## NixOS Configuration Files

| File | Purpose |
|------|---------|
| `hosts/Nexus/hardware-extra.nix` | LUKS crypttab, fileSystems, mergerfs mount |
| `hosts/Nexus/snapraid.nix` | SnapRAID configuration |
| `flake.nix` | agenix secrets for disk encryption keys |